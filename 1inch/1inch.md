



# 交易执行

* DEX聚合器都是使用 第三方执行者+荷兰拍卖 的方式去执行交易。用户在页面确定好数量，滑点，时间等相关参数后，此交易订单会进入池中，进行荷兰拍卖，执行者竞争交易。
* DEX 聚合器一般都有几个优点：
  * 无 GAS 交易
    * 通过链下签名授权的方式发生交易，只需要少量的 gas 来完成一开始的授权，但是第三方执行者在处理交易时会加入GAS成本计算，所以归根到底，gas 最终会体现到用户的交易价格中
  * 防 MEV
    * 交易本身不会进入内存池，直接和第三方执行者交易，所以无 MEV，即使发生 MEV（执行者可能就是 MEV searcher），收益在某种程度上说是与交易者共享的。
  * 支持限价单：
    * 支持指定价格成交，用户设置好兑换的价格，会进入DEX聚合器的中心化数据库，当达到指定价格时，进入正常交易流程

## 1inch

* 1inch 采用 resolver+荷兰拍卖处理交易，其中 resolver 是处理并执行交易的第三方。
* 在 1inch 中成为 resolver 需要质押 1inch，并且质押数量排在前十才有资格处理交易，并且质押数量越多，处理交易的优先度越高。
* 在进行荷兰拍卖时，价格随时间不断衰减，可处理交易的 resolver 的数量也在不断增加，可参考下图：
  * ![img2024-09-22 08.10.16](/Users/zhouwei/Desktop/contract/1inch/img/img2024-09-22 08.10.16.png)

* 可以看到随着时间的推移可处理交易的 resolver 的数量越多，这回迫使优先度高的 resolver 在获得交易执行权时，如有利可图，需尽快处理交易，否则会被后来 resolver 抢。
* 我们知道价格随时间不断衰减的，当衰减到我们设置的最大滑点，还没有 resolver 处理，那么此交易失败



## CowSwap

* CowSwap 采用 solver+批处理，其中 solver 就是第三方执行者，成为 solver 需要质押一定资金，并通过CowSwap 与社区的审核

* CowSwap 将收集到用户订单进行分组结算，然后通过竞争将这些批次“拍卖”，拍卖给为批次中的订单提供最多盈余的 solver

  

## Uniswap X

* Uniswap X 使用 fitter+荷兰拍卖，其中 fitter 就是第三方执行者，fitter 无需质押资金，但需要满足Uniswap的一些条件，可到官网查看。
* Uniswap X 会先将收集到的交易加入池中，进行荷兰拍卖，选取报价最优的 fitter 执行交易，filter 报价不会高于UniswapV2、V3的报价



# 流动性和价格数据

* DEX 聚合器是让用户以最优的价格成交订单，因此需要两个重要数据：
  * 不用 DEX 的流动性数据
  * 当前时间的代币价格 

# 交易路径

* DEX 聚合器最重要的一点是**如何寻找最优报价**，目前市场上有许多 DeFi 协议，每个协议都有自己的流动性，不同代币流动性不同，所以需要在一系列池子中，找到最优兑换路径，这个问题有两种常见方案：**线性路由**和**拆单路由**。

## 线性路由

* 每次交易只通过一个池子，交易资产不会拆分。假设用户需要交易ETH-DAI，线性路由所找到的最优路径为ETH-USDT-DAI，而不是 [A-C-B]+[A-D-B]，即A资产不会拆分为两部分选择不同的路。Uniswap 使用的就是这种路由
* 线性路由寻找最优交易路径问题，我们会将之转换为图，币种为节点，交易成本为边，如图所示
  * ![img2024-09-22 19.11.41](/Users/zhouwei/Desktop/contract/1inch/img/img2024-09-22 19.11.41.png)

* 所以最优交易路径问题，转化为图的最短路径问题。使用 DFS 即可找出最优路径，而且出于保证gas合理的考虑，遍历层数不会太多，时间复杂度也不会太高。

## 拆单路由

* 拆单路由就是将资金拆分为多份，使用户的资金按最优比例配置到不同池子进行兑换，以使得目标token报价最优。
* 假设用户需要交易ETH-DAI，其中 40% 通过 Uniswap ETH-USDT-DAI，60%通过 Balancer ETH-USDT-DAI
* 实现方式分为两种：零跳，多跳

### 零跳

* 假如有 N 个同名池子，1000 个 A Token 拆分为 K 份，对于每一个池子 N_i 将询价 K 次。将 K 份中的每一份记作 K_i，每次报价输出记作 O_i，那么求解最优路径即为找到一个拆分为 K 份的方式，使得每次输出的 Oi 之和为最大，这其实是一个**背包问题**。
* 假设有 4 个同名池子，1000 个 A Token 拆分为 100 份。
* 转换为背包问题就是，当前背包的重量为 100，有 400（100*4）个物品，每个物品价值为通过该池子交易得到的 token，求解将哪些物品装入背包里物品价值总和最大。
* 对于零跳询价来说，拆分数越小，询价速度越快，离散误差越大；拆分数越大，询价速度越慢，离散误差越小。1inch 基本采用固定拆分数，对于单跳，可选拆分数在 100 内，常用值为 50；Paraswap 的拆分数相对更灵活。DODO 则采取二分法辅助确定拆分数以尽可能地减少固定的拆分数带来的离散误差。具体实现为：在 0~100 的拆分数内随机选择一个拆分数 n，计算最优报价 p1；再计算拆分数为 2n 时的最优报价 p2， 若 p1 和 p2 的相对差值小于 0.001，则认为 n 为最优拆分数，否则，以 2n 为新的当前拆分数，继续进行二分检验，至差值小于 0.001 为止。

### 多跳

* A→C1→C2→…→Cn→B 这样一个路径可以使用多次零跳询价完成。先求解 A→C1，再 C1→C2，以此类推，即可获得最优价格和拆单方式。这样的方式也会增加询价时间和 gas 成本，因此，DODO 将中间币控制在两个以内，最优化交易路径。

# 收入来源

* 手续费：
  * UniswapX 收取 0.05% 的交易手续费
* 荷兰拍卖不断降低订单汇率
* 优化交易路径节省 gas 费用
* 批量处理交易而节省 gas 费用：
  * CowSwap 使用批处理可节省 gas
* 正滑点：
  * 聚合器大都使用荷兰拍卖的方式进行交易，所以交易执行不是实时的。假设，当用户买入 ETH 时，ETH 报价为 1000 美元，由于拍卖或网络拥堵导致最终结算时以太坊的市场价格已跌至 995 美元，但用户仍然需要支付 1000 美元购买一个以太坊，也就是说，交易者**多付了 5 美元**购买 ETH，这 5 美元就是正滑点。
* 平台奖励：
  * 对处理交易的第三方执行者奖励协议原生token
* 等等......



# 参考文章